<!DOCTYPE html>
<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>Cards Against Humanity</title>
</head>

<body>
    <div id="create-player">
        <input type="text" placeholder="Name" id="name" />
        <button onClick="CreatePlayer();">Create player</button>
    </div>

    <div id="join-game" style="display: none;">
        <span id="welcome"></span>
        <button onClick="JoinGame(gameId, playerId);">Join game</button>
    </div>

    <div id="question" style="display: none;">
        <span id="question-card"></span>
    </div>

    <select id="answer" style="display: none;">
        <option id="ans1" value=1></option>
        <option id="ans2" value=2></option>
        <option id="ans3" value=3></option>
        <option id="ans4" value=4></option>
        <option id="ans5" value=5></option>
        <option id="ans6" value=6></option>
        <option id="ans7" value=7></option>
    </select>

    <select id="czar-choice" style="display: none;">
    </select>

    <div id="submit-answer" style="display: none;">
        <button onClick="SubmitAnswer(playerId);">Submit answer</button>
    </div>

    <div id="submit-choice" style="display: none;">
        <button onClick="SubmitChoice(playerId);">Submit choice</button>
    </div>

    <div id="answer-submited" style="display: none;">
        <span>Answer submited</span>
    </div>

    <div id="choice-submited" style="display: none;">
        <span>Choice submited</span>
    </div>

    <script>
        var name = "";
        var playerId = null;
        var gameId = 1;
        var numGaps = 0;
        var gapCountdown = 0
        var listAns = "[";

        async function CreatePlayer() {
            response = await fetch("/create_player", { method: "POST" });
            json = await response.json();
            playerId = JSON.parse(json);
            name = $("#name").val();
            $("#welcome").html("Welcome " + name);
            $("#create-player").css("display", "none");
            $("#join-game").css("display", "inline");
        }

        async function JoinGame(game_id, player_id) {
            // TODO: check if there is already a game and if there isnt create a new one
            await fetch("/join_game/" + game_id + "/" + player_id, { method: "POST" });
            $("#join-game").css("display", "none");
            $("#question").css("display", "inline");
            response = await fetch("/return_qcard/" + gameId);
            json = await response.json();
            qcard = json;
            numGaps = qcard[1];
            gapCountdown = numGaps;
            $("#question").html(qcard[0]);
            response = await fetch("/czar/" + gameId + "/" + player_id);
            json = await response.json();
            czar = JSON.parse(json);
            if (czar == false) {
                $("#answer").css("display", "inline");
                $("#submit-answer").css("display", "inline");
                response = await fetch("/deal_cards/" + player_id, { method: "POST" });
                json = await response.json();
                cards = json;
                for (let i = 0; i < 7; i++) {
                    $("#ans" + (i + 1)).html(cards[i]);
                }
            } else {
                playerChoices = [false]
                $("#submit-choice").css("display", "inline");
                while (playerChoices[0] == false) {
                    await timeout(1000);
                    playerChoices = await CheckPlayerChoices();
                }
                CreateDropdownCzar(playerChoices[1])
                $("#czar-choice").css("display", "inline");
            }
        }

        async function CreateDropdownCzar(choices) {
            playerChoice = ""
            $("#czar-choice").find("option").remove();
            for (var choice of choices) {
                for (var card of choice[1]) {
                    response = await fetch("/answer_card/" + card);
                    json = await response.json();
                    ans = json;
                    playerChoice = playerChoice + ans["text"] + " + "
                }
                var option = new Option(playerChoice, choice[0]);
                $("#czar-choice").append(option);
                playerChoice = ""
            }
        }

        async function SubmitAnswer(player_id) {
            if (gapCountdown != 1) {
                choice = $("#answer").val();
                listAns = listAns + choice + ",";
                gapCountdown -= 1;
            } else {
                czarChoice = [false]
                choice = $("#answer").val();
                listAns = listAns + choice + "]";
                await fetch("/save_choice/" + player_id + "/" + listAns, { method: "POST" });
                listAns = "[";
                $("#question").css("display", "none");
                $("#answer").css("display", "none");
                $("#submit-answer").css("display", "none");
                $("#answer-submited").css("display", "inline");
                while (czarChoice[0] == false) {
                    await timeout(1000);
                    czarChoice = await CheckCzarChoice();
                }
                // TODO: display the points of each player
                if (czarChoice[1] == player_id) {
                    $("#answer-submited").html("Congratulations, you won the round!!!");
                } else {
                    $("#answer-submited").html("Unfortunately, you didnt win the round");
                }
            }
        }

        // https://stackoverflow.com/questions/33289726/combination-of-async-function-await-settimeout
        function timeout(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function CheckCzarChoice() {
            response = await fetch("/return_czar_choice/" + gameId);
            json = await response.json();
            choice = json;
            return choice;
        }

        async function CheckPlayerChoices() {
            response = await fetch("/return_choices/" + gameId);
            json = await response.json();
            choice = json;
            return choice;
        }

        async function SubmitChoice(player_id) {
            pointWinner = $("#czar-choice").val();
            await fetch("/give_points/" + player_id + "/" + pointWinner, { method: "POST" });
            $("#choice-submited").css("display", "inline");
            $("#submit-choice").css("display", "none");
            $("#czar-choice").css("display", "none");
            $("#question").css("display", "none");
        }

        async function EveryoneIn() {
            await fetch("/???");
        }


        /*
    async function SubmitChoice() {
        yooo = $("#czar-choice").val();
        woop = $("#p4").val();
        $("#question").css("display", "inline");
        $("#question").html(woop);
        $("#p1").html("yeppppppppppp");
    }

    b = $("#ans" + (i + 1)).html();
    $("#ans" + (i + 2)).html(b);

        */

    </script>

</body>

</html>